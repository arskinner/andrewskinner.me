---
import { getCollection } from 'astro:content'
import PageLayout from '@layouts/PageLayout.astro'
import Container from '@components/Container.astro'
import { dateRange } from '@lib/utils'
import { WORK } from '@consts'

const workCollection = (await getCollection('work')).sort((a, b) =>
  a.data.dateEnd === 'Present'
    ? -1
    : new Date(b.data.dateEnd).valueOf() - new Date(a.data.dateEnd).valueOf()
)

const work = await Promise.all(
  workCollection.map(async (item) => {
    const { Content } = await item.render()
    return { ...item, Content }
  })
)

const projectCollection = (await getCollection('projects')).filter(
  (project) => !project.data.draft
)

const projects = await Promise.all(
  projectCollection.map(async (item) => {
    const { Content } = await item.render()
    return { ...item, Content }
  })
)
---

<PageLayout title={WORK.TITLE} description={WORK.DESCRIPTION}>
  <Container>
    <div class="space-y-10">
      <div class="animate font-semibold text-black dark:text-white">Work</div>
      <ul class="flex flex-col space-y-4">
        {
          work.map((entry) => (
            <li class="animate">
              <div class="text-sm opacity-75">
                {dateRange(entry.data.dateStart, entry.data.dateEnd)}
              </div>
              <div class="font-semibold text-lg text-black dark:text-white">
                {entry.data.company}
              </div>
              <div class="text-sm opacity-75">{entry.data.role}</div>
              <article>
                <entry.Content />
              </article>

              {entry.data.showProjects && (
                <div class="mt-4 mb-4 border-l-2 border-slate-300 dark:border-white dark:border-opacity-25 pl-4 print:pl-0 print:border-t-2 print:border-l-0 print:pt-4 print:border-b-2 print:pb-2 print:border-black">
                  <div class="font-semibold text-black dark:text-white mb-4">
                    Select Projects
                  </div>

                  {projects.map((project) => (
                    <div class="mb-4">
                      <div class="text-black mb-2 dark:text-white">
                        {project.data.title}
                      </div>
                      <div class="text-md">
                        <project.Content />
                      </div>
                      <div class="mt-2 text-sm opacity-75">
                        Technology:
                        <span class="italic">{project.data.technology}</span>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </li>
          ))
        }
      </ul>
    </div>
  </Container>
</PageLayout>
